name: Build

on: [push]

jobs:
  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 12
      - name: npm install, build, and test
        run: |
          npm install
          npm run build --if-present
          npm test
      - name: Create artifact
        run: zip artifact.zip ./tellme/static/tellme/feedback/dist/feedback*
      - name: Archive production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: frontend-assets
          retention-days: 5
          path: artifact.zip
  backend:
    needs: frontend
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        #python-version: [2.7,3.4,3.5,3.6,3.7,3.8,3.9]
        python-version: [3.6]
        #django: [18,19,110,111,20,30,31]
        django: [30]
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Tox and any other packages
        run: python -m pip install tox tox-gh-actions
      - name: Download frontend dist
        uses: actions/download-artifact@v2
        with:
          name: frontend-assets
      - name: Unpack artifact
        run: unzip artifact.zip
      - name: Run Tox
        # Run tox using the version of Python in `PATH`
        run: python -m tox -vv
        env:
          DJANGO: ${{ matrix.django }}
      - name: Archive production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: backend-assets
          retention-days: 5
          path: '~/.tox/distshare'
